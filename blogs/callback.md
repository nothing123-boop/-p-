# MugglePay掉单须知

## 什么是掉单？

掉单属于支付中的一种严重错误。 掉单，就是用户支付成功，但由于各种客观原因，商家未给用户发货（或者无法判别是否已经发货）。

MugglePay有自己的补单策略，一般如果由于系统临时不稳定而造成的掉单，会在接下来的5，10，30分钟内进行自动补单。


### 如何发现自己是否掉单？

 * 如果你绑定了麻瓜宝机器人，会收到消息推送回调失败。如果未绑定麻瓜宝机器人，请先完成MugglePay新手指南。
 * MugglePay商家后台，订单管理，会提示订单支付成功，但是回调失败
 
### 如何补单？

 * 登录MugglePay商家后台，查看订单管理，可以看到订单支付成功，但是回调失败。请点击“手工补单”。此时会重新发送请求。
 * 如果“手工补单”操作后，问题仍然没有解决，请先按照常见问题修复后再次尝试。
 * 如果常见问题操作后，如果你的服务器仍然没有收到通知，没有给用户发货。建议先自行暂停收款，在MugglePay提交工单或者联系技术人员解决问题后继续使用。
 * 如果你的服务器收到通知，但是在MugglePay后台显示没有成功。请先手工"标记已完成"。是偶尔一两单，可以手工标记即可。如果经常发生，请先确保你的技术对接无误后再上线。


## 常见问题

如果超过时间未处理，或者问题持续严重，可能会导致收款权限临时关闭，从而对业务造成影响。如果订单超过30分钟未补单，会收到邮件或者TG通知，通知您紧急处理。

 * 如果你是第一次使用MugglePay服务，95%的概率是你还没有完成技术配置。请查看SDK以及接口文档。在MugglePay提交工单或者联系技术人员解决问题后再继续在Production使用。
 * 如果你已经用了MugglePay服务一段时间，95%的概率是你做了下面的这些改动，请先朗读下面几个文字（读出声来）。
 * 1）我还是用的旧域名，SSL证书没有过期。如果你最近使用新域名，SSL证书，请自行确认配置
 * 2）我还是用相同的服务器，相同的建站工具。如果你换了服务器，或者建站工具，请自行确认配置
 * 3）我没有修改过我的服务配置。如果你修改过CF，例如防护盾，强制ssl调整等等，请按照下面操作配置后再试。
 

如果您收到邮件或者消息提示，请赶紧按照下面步骤排查解决：

### 1. 开启了CloudFront防护盾

如果是设置防火墙，可以单独为麻瓜宝设置一个回调子域名（不受cf防护影响），或者设置域名白名单。下午的域名和路径仅供参考。真实的路径请看自己的网站设置（或者机器人消息推送会提示）
<br />
温馨提示：如果你存在多个域名，你可以不用完全匹配，选择 URI Path =》 Cointains =》 "payment/bacllback"即可。

<img src="https://cdn.mugglepay.com/pay/instructions/callback.jpg" />


### 2. HTTPS 以及 SSL

如果使用https，请确认ssl证书无误。例如SSL是否过期了？
最好支持支持tsl1.0


### 3. 域名跳转

例如如果你的域名设置了强制跳转，例如http -> https, vipcloud.com -> www.vipcloud.com，都可能造成回调失败。
如果是这种情况，请把callback_url设置为最终url，上面的例子为https://www.vipcloud.com


### 4. 维护中，DDos/CC，或者使用新域名站点

请务必确保网站服务器正常再使用收款。你可以先自行暂停收款，并且设置好防护或者正常运作后收款。


### 5. 回调域名解析

请使用主流域名作为回调地址，如果是vipcloud.xyt 可能无法解析，尽量使用vipcloud.com, vipcloud.io之类主流域名后缀。

### 5. 插件过期

如果你是最近1个月才开始使用，请获取最新的插件代码。

### 6. 开启防火墙

如果你最近开启了防火墙，先试下关闭防火墙，并且手工补单。如果成功，说明是防火墙造成的。解决方案：

 - 由于回调的ip会更换，所以ip白名单不能永久解决问题
 - 后端代码有一个参数callback_url，你可以改为单独的一个子域名（这个子域名不开启防火墙）
 - 或者把 callback_url 改为一个 http://ip 


